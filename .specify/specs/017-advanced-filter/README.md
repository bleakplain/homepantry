# Spec 017: 高级筛选

**Spec ID**: 017
**功能名称**: 高级筛选
**优先级**: P1
**状态**: 🚧 规划中
**创建日期**: 2026-02-20
**最后更新**: 2026-02-20

---

## 文档列表

| 文档 | 描述 | 字符数 |
|------|------|--------|
| [spec.md](./spec.md) | 需求规范（What + Why） | 4,093 |
| [plan.md](./plan.md) | 技术方案（技术栈 + 架构） | 12,413 |
| [data-model.md](./data-model.md) | 数据模型（实体定义） | 5,457 |
| [tasks.md](./tasks.md) | 任务清单（实现步骤） | 4,475 |
| [research.md](./research.md) | 技术调研（选型 + 问题） | 6,427 |
| **总计** | - | **32,865** |

---

## 核心内容

### What（做什么）

**核心功能**:
1. **按烹饪时间筛选**（<15、15-30、30-60、>60 分钟）
2. **按难度筛选**（简单、中等、困难）
3. **按食材筛选**（包含/排除、"使用现有食材"）
4. **按分类筛选**（菜系、类型）
5. **组合筛选**（多个条件 AND 关系，实时更新）

### Why（为什么）

**对用户的价值**:
- 更精确的搜索结果
- 节省查找时间
- 提升用户体验

**对产品的价值**:
- 提升搜索功能的使用率
- 增加用户粘性
- 为个性化推荐提供数据支持

---

## 技术实现

### 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Kotlin | 1.9+ | 开发语言 |
| Jetpack Compose | 1.5+ | UI 框架 |
| Room | 2.6+ | 本地数据库 |
| Navigation Compose | 2.7+ | 页面导航 |
| Coroutines | 1.7+ | 异步处理 |
| ViewModel | 2.6+ | 状态管理 |
| Flow | Kotlin | 数据流 |

### 架构设计

```
┌─────────────────────────────────────────────┐
│                    Presentation Layer               │
│  ┌──────────────────┐  ┌──────────────────────┐   │
│  │ FilterDialog    │  │  RecipeListScreen    │   │
│  │  (筛选对话框)    │  │  (菜谱列表+筛选)      │   │
│  └──────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────┐
│                     Domain Layer                    │
│  ┌──────────────────┐  ┌──────────────────────┐   │
│  │FilterRepository │  │  RecipeRepository      │   │
│  │  (筛选仓库)      │  │  (菜谱仓库)           │   │
│  └──────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────┐
│                        Data Layer                    │
│  ┌──────────────────┐  ┌──────────────────────┐   │
│  │FilterDao        │  │  RecipeDao            │   │
│  │  (筛选数据)      │  │  (菜谱数据)           │   │
│  └──────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────┐
│                     Room Database                    │
│              (SQLite 本地数据库)                     │
└─────────────────────────────────────────────┘
```

---

## 数据模型

### 核心实体

1. **RecipeFilter（菜谱筛选器）**
   - id, cookingTimeMin, cookingTimeMax
   - difficultyMin, difficultyMax
   - includedIngredients, excludedIngredients
   - categoryIds
   - createdAt, updatedAt

2. **RecipeFilterCriteria（筛选条件）**
   - cookingTimeMin/Max, difficultyMin/Max
   - includedIngredients（Set）, excludedIngredients（Set）
   - categoryIds（Set）
   - isEmpty(): Boolean

---

## 实现状态

### 🚧 规划中

**待实现**:
- [x] spec.md（需求规范）
- [x] plan.md（技术方案）
- [x] data-model.md（数据模型）
- [x] tasks.md（任务清单）
- [x] research.md（技术调研）
- [x] README.md（文档总结）

**待开发**:
- [ ] 数据层（Entity、DAO、Repository）
- [ ] 业务逻辑层（ViewModel）
- [ ] 表现层（FilterDialog、FilterBadge 等）
- [ ] 导航和集成
- [ ] 测试

---

## 验收标准

### 功能验收

- [ ] 可以按烹饪时间筛选（<15、15-30、30-60、>60 分钟）
- [ ] 可以按难度筛选（简单、中等、困难）
- [ ] 可以按食材筛选（包含/排除、"使用现有食材"）
- [ ] 可以按分类筛选（菜系、类型）
- [ ] 可以组合多个筛选条件（AND 关系）
- [ ] 实时更新筛选结果

### 性能验收

- [ ] 筛选响应时间 < 500ms（单条件）
- [ ] 筛选响应时间 < 1s（组合条件、食材）
- [ ] 1000 个菜谱筛选 < 500ms
- [ ] 10000 个菜谱筛选 < 1s
- [ ] 内存占用 < 100MB（筛选操作）

### 测试验收

- [ ] 单元测试覆盖率 ≥ 70%
- [ ] 筛选准确率 ≥ 98%
- [ ] 组合筛选成功率 ≥ 95%

---

## 开发计划

### 阶段 1：数据层（1 天）

- [ ] 创建 RecipeFilter Entity
- [ ] 创建 RecipeFilterDao
- [ ] 创建 RecipeFilterRepository

### 阶段 2：业务逻辑层（0.5 天）

- [ ] 创建 FilterViewModel
- [ ] 创建 FilterDialogViewModel

### 阶段 3：表现层（1.5 天）

- [ ] 创建 FilterDialog
- [ ] 创建 CookingTimeFilterSection
- [ ] 创建 DifficultyFilterSection
- [ ] 创建 IngredientFilterSection
- [ ] 创建 CategoryFilterSection
- [ ] 创建 PresetsSection
- [ ] 创建 FilterBadge

### 阶段 4：导航和集成（0.5 天）

- [ ] 配置筛选对话框路由
- [ ] 集成到菜谱列表页

### 阶段 5：测试（1 天）

- [ ] 编写单元测试
- [ ] 编写集成测试
- [ ] 测试覆盖率检查

**总预计时间**: 4 天

---

## 性能测试结果

| 操作 | 目标 | 预期 | 状态 |
|------|------|------|------|
| 单条件筛选 | < 500ms | 50ms | ⏳ 待验证 |
| 组合筛选 | < 500ms | 100ms | ⏳ 待验证 |
| 食材筛选（10 个） | < 1s | 300ms | ⏳ 待验证 |
| 食材筛选（20 个） | < 1s | 800ms | ⏳ 待验证 |
| 大数据量筛选（10000 个） | < 1s | 500ms | ⏳ 待验证 |

---

## 已知问题和优化方向

### 已知问题

1. **大量食材筛选性能**
   - 影响：选择 20 个食材时，筛选可能变慢
   - 解决方案：使用索引、限制食材数量
   - 状态：✅ 已实现

2. **组合查询的索引优化**
   - 影响：多个条件组合时，可能无法有效使用索引
   - 解决方案：创建复合索引
   - 状态：✅ 已实现

### 优化方向

1. **全文搜索**（优先级 P2）
   - 使用 FTS (Full-Text Search)
   - 提升食材筛选性能
   - 支持模糊搜索

2. **保存筛选条件为预设**（优先级 P2）
   - 允许用户保存常用筛选
   - 快速应用预设筛选

3. **语音搜索**（优先级 P3）
   - 语音输入筛选条件
   - 提升易用性

---

## 参考资料

- [spec.md](./spec.md)
- [plan.md](./plan.md)
- [data-model.md](./data-model.md)
- [tasks.md](./tasks.md)
- [research.md](./research.md)
- [REQUIREMENTS.md](../../../docs/REQUIREMENTS.md)
- [ARCHITECTURE.md](../../../docs/ARCHITECTURE.md)
- [Constitution](../memory/constitution.md)

---

## 文档版本

| 版本 | 日期 | 更新内容 | 负责人 |
|------|------|----------|--------|
| 1.0 | 2026-02-20 | 初始版本 | Jude 🦞 |

---

**负责人**: Jude 🦞
**最后更新**: 2026-02-20
**状态**: 🚧 规划中，准备开始开发
