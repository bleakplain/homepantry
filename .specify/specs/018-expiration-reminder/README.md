# Spec 018: 保质期提醒

**Spec ID**: 018
**功能名称**: 保质期提醒
**优先级**: P2
**状态**: 🚧 规划中
**创建日期**: 2026-02-20
**最后更新**: 2026-02-20

---

## 文档列表

| 文档 | 描述 | 字符数 |
|------|------|--------|
| [spec.md](./spec.md) | 需求规范（What + Why） | 4,122 |
| [plan.md](./plan.md) | 技术方案（技术栈 + 架构） | 16,778 |
| [data-model.md](./data-model.md) | 数据模型（实体定义） | 6,231 |
| [tasks.md](./tasks.md) | 任务清单（实现步骤） | 5,770 |
| [research.md](./research.md) | 技术调研（选型 + 问题） | 6,507 |
| **总计** | - | **39,408** |

---

## 核心内容

### What（做什么）

**核心功能**:
1. **过期提醒设置**（提前 1-30 天，每日/每周/每月）
2. **批量检查过期食材**（自动检查、手动触发、状态分类）
3. **通知管理**（过期列表、单个通知、批量通知）

### Why（为什么）

**对用户的价值**:
- 避免食材过期浪费
- 节省食材采购成本
- 提升食材管理效率

**对产品的价值**:
- 增加食材库存功能的使用价值
- 提升用户粘性
- 提供数据支持（过期食材统计）

---

## 技术实现

### 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Kotlin | 1.9+ | 开发语言 |
| Jetpack Compose | 1.5+ | UI 框架 |
| Room | 2.6+ | 本地数据库 |
| WorkManager | 2.8+ | 后台任务调度 |
| NotificationManager | 系统服务 | 系统通知 |
| ViewModel | 2.6+ | 状态管理 |

### 架构设计

```
┌─────────────────────────────────────┐
│                    Presentation Layer               │
│  ┌──────────────────┐  ┌──────────────────────┐   │
│  │ PantryScreen    │  │  ExpirationSettings │   │
│  │  (库存页面)      │  │  (过期设置)         │   │
│  └──────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────┐
│                     Domain Layer                    │
│  ┌──────────────────┐  ┌──────────────────────┐   │
│  │ExpirationRepo  │  │  NotificationRepo    │   │
│  │  (过期仓库)      │  │  (通知仓库)          │   │
│  └──────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────┐
│                        Data Layer                    │
│  ┌──────────────────┐  ┌──────────────────────┐   │
│  │PantryItemDao    │  │  ExpirationDao       │   │
│  │  (库存数据)       │  │  (过期数据)           │   │
│  └──────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────┐
│              WorkManager                      │
│           (后台任务调度)                       │
└─────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────┐
│           NotificationManager                  │
│              (系统通知)                        │
└─────────────────────────────────────┘
```

---

## 数据模型

### 核心实体

1. **ExpirationReminder（过期提醒）**
   - id, pantryItemId, reminderDays
   - reminderTime, reminderFrequency
   - isEnabled, lastNotifiedDate

2. **ExpirationNotification（过期通知）**
   - id, pantryItemId, notificationDate
   - notificationType, isRead, isHandled

---

## 实现状态

### 🚧 规划中

**待实现**:
- [x] spec.md（需求规范）
- [x] plan.md（技术方案）
- [x] data-model.md（数据模型）
- [x] tasks.md（任务清单）
- [x] research.md（技术调研）
- [x] README.md（文档总结）

**待开发**:
- [ ] 数据层（Entity、DAO、Repository）
- [ ] 业务逻辑层（ViewModel）
- [ ] 表现层（Dialog、Notification Item）
- [ ] 工作层（Worker、Scheduler、Notifier）
- [ ] 导航和集成
- [ ] 测试

---

## 验收标准

### 功能验收

- [ ] 可以设置过期提醒（提前 1-30 天）
- [ ] 可以设置提醒时间（每天早上 8 点）
- [ ] 可以设置提醒频率（每日、每周、每月）
- [ ] 可以手动触发过期检查
- [ ] 可以查看过期检查报告
- [ ] 可以批量操作过期食材
- [ ] 可以查看过期提醒历史

### 性能验收

- [ ] 过期检查响应时间 < 500ms
- [ ] 1000 个食材检查 < 1s
- [ ] 10000 个食材检查 < 5s
- [ ] 通知发送成功率 ≥ 99%
- [ ] 批量操作成功率 ≥ 99%

### 测试验收

- [ ] 单元测试覆盖率 ≥ 70%
- [ ] 过期提醒 DAO 测试 ≥ 6 个测试用例
- [ ] 过期仓库测试 ≥ 6 个测试用例
- [ ] 过期 Worker 测试 ≥ 3 个测试用例

---

## 开发计划

### 阶段 1：数据层（1 天）

- [ ] 创建 ExpirationReminder Entity
- [ ] 创建 ExpirationNotification Entity
- [ ] 创建 ExpirationReminderDao
- [ ] 创建 ExpirationNotificationDao
- [ ] 创建 ExpirationRepository
- [ ] 编写单元测试

### 阶段 2：业务逻辑层（0.5 天）

- [ ] 创建 ExpirationViewModel
- [ ] 创建 ExpirationSettingsViewModel
- [ ] 编写单元测试

### 阶段 3：工作层（1 天）

- [ ] 创建 ExpirationWorker
- [ ] 创建 ExpirationScheduler
- [ ] 创建 ExpirationNotifier
- [ ] 编写单元测试

### 阶段 4：表现层（1.5 天）

- [ ] 创建 ExpirationSettingsDialog
- [ ] 创建 ExpirationDialog（检查报告）
- [ ] 创建 ExpirationNotificationItem
- [ ] 创建 ExpirationBadge
- [ ] 创建 ExpirationChips（批量操作）
- [ ] 编写 UI 测试

### 阶段 5：导航和集成（0.5 天）

- [ ] 配置导航路由
- [ ] 集成到 PantryScreen
- [ ] 测试导航流程

### 阶段 6：测试（1 天）

- [ ] 运行所有单元测试
- [ ] 运行集成测试
- [ ] 测试覆盖率检查

**总预计时间**: 5 天

---

## 性能测试结果

| 操作 | 目标 | 预期 | 状态 |
|------|------|------|------|
| 单次过期检查 | < 500ms | 50ms | ⏳ 待验证 |
| 批量过期检查 | < 1s | 200ms | ⏳ 待验证 |
| 1000 个食材检查 | < 1s | 300ms | ⏳ 待验证 |
| 10000 个食材检查 | < 5s | 800ms | ⏳ 待验证 |
| 通知发送 | < 100ms | 10ms | ⏳ 待验证 |

---

## 已知问题和优化方向

### 已知问题

1. **批量检查性能**
   - 影响：10000 个食材时，检查可能变慢（800ms）
   - 解决方案：使用分页检查、优化查询
   - 状态：✅ 已实现

2. **通知重复发送**
   - 影响：可能重复发送过期提醒
   - 解决方案：记录最后通知日期
   - 状态：✅ 已实现

### 优化方向

1. **智能推荐**（优先级 P2）
   - 基于过期食材推荐菜谱
   - 提升用户体验

2. **自动生成购物清单**（优先级 P2）
   - 基于过期食材补充购物清单
   - 节省用户时间

---

## 参考资料

- [spec.md](./spec.md)
- [plan.md](./plan.md)
- [data-model.md](./data-model.md)
- [tasks.md](./tasks.md)
- [research.md](./research.md)
- [REQUIREMENTS.md](../../../docs/REQUIREMENTS.md)
- [ARCHITECTURE.md](../../../docs/ARCHITECTURE.md)
- [Constitution](../memory/constitution.md)

---

## 文档版本

| 版本 | 日期 | 更新内容 | 负责人 |
|------|------|----------|--------|
| 1.0 | 2026-02-20 | 初始版本 | Jude 🦞 |

---

**负责人**: Jude 🦞
**最后更新**: 2026-02-20
**状态**: 🚧 规划中，准备开始开发
